<div class="govuk-accordion" data-module="govuk-accordion" id="accordion-default">
  <div class="govuk-accordion__section">
    <div class="govuk-accordion__section-header">
      <h3 class="govuk-accordion__section-heading">
        <!-- We have removed aria controls due to a problem with the default npm gov-uk functionality, which forces accordions to stay open by using the aria controls classes to setState in the browser, and force them open.
      Our research suggests this makes the website harder to use as there is too much information on the screen overwhelming the user.
      For now we are removing these until we create our own version of the gov-uk library that stops the behaviour of forcing accordions open. -->
        <button type="button" id="accordion-default-heading-1" aria-controls="" class="govuk-accordion__section-button" aria-expanded="false">
          Constraints
        </button>
        <span class="govuk-accordion__icon" aria-hidden="true"></span>
      </h3>
    </div>
    <div class="govuk-accordion__section-content" aria-labelledby="accordion-default-heading-1" id="constraints-section">
      <% if @planning_application.updated_address_or_boundary_geojson %>
        <%= render "shared/warning_text",
          message: "This application has been updated. Please check the constraints are correct." %>
      <% end %>

      <% if planning_constraints_feedback = @planning_application.feedback["planning_constraints"] %>
        <%= render "shared/warning_text",
          message: "The applicant or agent believes the constraints are inaccurate." %>

        <p class="govuk-body">
          <strong>Reason given:</strong> "<%= planning_constraints_feedback %>"
        </p>

        <hr class="govuk-section-break govuk-section-break--l govuk-section-break--visible">
      <% end %>

      <%= render "constraints/info" %>
    </div>
  </div>
  <div class="govuk-accordion__section">
    <div class="govuk-accordion__section-header">
      <h3 class="govuk-accordion__section-heading">
        <!-- We have removed aria controls due to a problem with the default npm gov-uk functionality, which forces accordions to stay open by using the aria controls classes to setState in the browser, and force them open.
      Our research suggests this makes the website harder to use as there is too much information on the screen overwhelming the user.
      For now we are removing these until we create our own version of the gov-uk library that stops the behaviour of forcing accordions open. -->
        <button type="button" id="accordion-default-heading-1" aria-controls="" class="govuk-accordion__section-button" aria-expanded="false">
          Key application dates
        </button>
        <span class="govuk-accordion__icon" aria-hidden="true"></span>
      </h3>
    </div>
    <div class="govuk-accordion__section-content" aria-labelledby="accordion-default-heading-1">
      <p class="govuk-body">
        <strong>Application received:</strong>
        <%= @planning_application.received_at %>
      </p>
      <p class="govuk-body">
        <strong>Valid from:</strong>
        <% if @planning_application.valid_from.present? %>
          <%= @planning_application.valid_from %>
        <% else %>
          Not yet valid
        <% end %>
      </p>
      <p class="govuk-body">
        <strong>Target date:</strong>
        <%= @planning_application.target_date %>
      </p>
      <p class="govuk-body">
        <strong>Expiry date:</strong>
        <%= @planning_application.expiry_date %>
      </p>
    </div>
  </div>
  <div class="govuk-accordion__section">
    <div class="govuk-accordion__section-header">
      <h2 class="govuk-accordion__section-heading">
        <!-- We have removed aria controls due to a problem with the default npm gov-uk functionality, which forces accordions to stay open by using the aria controls classes to setState in the browser, and force them open.
      Our research suggests this makes the website harder to use as there is too much information on the screen overwhelming the user.
      For now we are removing these until we create our own version of the gov-uk library that stops the behaviour of forcing accordions open. -->
        <button type="button" id="accordion-default-heading-3" aria-controls="" class="govuk-accordion__section-button" aria-expanded="true">
          Contact information
        </button>
        <span class="govuk-accordion__icon" aria-hidden="true"></span>
      </h2>
    </div>
    <div class="govuk-accordion__section-content" aria-labelledby="accordion-default-heading-3">
      <% if @planning_application.user_role? %>
        <p class='govuk-body'>
          <strong>Applicant role type: </strong><br>
          <%= @planning_application.user_role %>
        </p>
      <% end %>
      <% if @planning_application.agent? %>
        <p class='govuk-body'>
          <strong>Agent: </strong><br>
          <% @planning_application.agent_contact_details.each do |info| %>
            <%= info %><br/>
          <% end %>
        </p>
      <% end %>
      <% if @planning_application.applicant? %>
        <p class='govuk-body'>
          <strong>Applicant: </strong><br/>
          <% @planning_application.applicant_contact_details.each do |info| %>
            <%= info %><br/>
          <% end %>
        </p>
      <% end %>
    </div>
  </div>
  <div class="govuk-accordion__section">
    <div class="govuk-accordion__section-header">
      <h2 class="govuk-accordion__section-heading">
        <!-- We have removed aria controls due to a problem with the default npm gov-uk functionality, which forces accordions to stay open by using the aria controls classes to setState in the browser, and force them open.
      Our research suggests this makes the website harder to use as there is too much information on the screen overwhelming the user.
      For now we are removing these until we create our own version of the gov-uk library that stops the behaviour of forcing accordions open. -->
        <button type="button" id="accordion-default-heading-4" aria-controls="" class="govuk-accordion__section-button" aria-expanded="true">
          Consultation
        </button>
        <span class="govuk-accordion__icon" aria-hidden="true"></span>
      </h2>
    </div>
    <div class="govuk-accordion__section-content" aria-labelledby="accordion-default-heading-4">
      <p class='govuk-body'>Consultation is not applicable for proposed permitted development.</p>
    </div>
  </div>
  <div class="govuk-accordion__section">
    <div class="govuk-accordion__section-header">
      <h2 class="govuk-accordion__section-heading">
        <button class="govuk-accordion__section-button" id="audit-log">
          Audit log
        </button>
        <span class="govuk-accordion__icon" aria-hidden="true"></span>
      </h2>
    </div>
    <div class="govuk-accordion__section-content" id="latest-audit" aria-labelledby="audit-log">
      <% if @last_audit.present? %>
        <p class="govuk-body">

          <%= render "audits/types/#{audit_entry_template(@last_audit)}", locals: { item: @last_audit } %>

          <p class="govuk-body">
            <%= define_audit_user(@last_audit) %>
          </p>
          <p class="govuk-body">
            <%= @last_audit.created_at.to_date %> at <%= @last_audit.created_at.strftime("%H:%M") %>
          </p>
        </p>
      <% end %>
      <p class='govuk-body'>
        <%= link_to "View all audits", planning_application_audits_path(@planning_application), class: "govuk-link" %>
      </p>
    </div>
  </div>
  <div class="govuk-accordion__section">
    <div class="govuk-accordion__section-header">
      <h2 class="govuk-accordion__section-heading">
        <span class="govuk-accordion__section-button" id="notes-section">
          Notes
        </span>
        <span class="govuk-accordion__icon" aria-hidden="true"></span>
      </h2>
    </div>
    <div class="govuk-accordion__section-content" aria-labelledby="notes-section">
      <% if @planning_application.notes.any? %>
        <p class='govuk-body'>
          <%= truncate @planning_application.notes.first.entry, length: 200 %>
        </p>
        <p class='govuk-body'>
          <%= @planning_application.notes.first.created_at %>
        </p>
        <p class='govuk-body'>
          <%= link_to "Add and view all notes", planning_application_notes_path(@planning_application), class: "govuk-link" %>
        </p>
      <% else %>
        <p class='govuk-body'>
          <%= link_to "Add a note", planning_application_notes_path(@planning_application), class: "govuk-link" %>
        </p>
      <% end %>
    </div>
  </div>
</div>
<% if @planning_application.in_progress? %>
  <div class="govuk-grid-row">
    <div class="govuk-grid-column-full cancel">
      <p class="govuk-body">
        <%= link_to "Close or cancel application", close_or_cancel_confirmation_planning_application_path(@planning_application), class: "govuk-link" %>
      </p>
    </div>
  </div>
<% end %>
