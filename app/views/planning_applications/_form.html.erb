<%= form_with model: @planning_application do |form| %>
  <%= form.govuk_error_summary(presenter: ErrorPresenter) %>

  <%= form.hidden_field(
    :return_to,
    value: local_assigns.fetch(:return_to, nil)
  ) %>
  <div class="govuk-form-group">
    <% if action_name == "new" || action_name == "create" %>
      <div class="govuk-form-group govuk-!-margin-bottom-4">
        <%= form.govuk_select(:application_type_id, ApplicationType.menu, options: { include_blank: true }, label: { text: "Application type" }) %>
      </div>
      
      <p class="govuk-body">
        <%= form.label :description, "Description", class: "govuk-heading-m govuk-!-margin-bottom-1" %>
        <%= form.text_area :description, class: "govuk-textarea", rows: "5" %>
      </p>
    <% else %>
      <p class="govuk-body">
        <% if @planning_application.description_change_validation_requests.open.any? %>
          <%= link_to "View requested change", planning_application_validation_description_change_validation_request_path(@planning_application, @planning_application.description_changes_validation_request.id), class: "govuk-link" %>
        <% elsif !@planning_application.closed_or_cancelled? %>
          <%= link_to "Propose a change to the description", new_planning_application_validation_description_change_validation_request_path(@planning_application, type: "description_change"), class: "govuk-link" %>
        <% end %>
      </p>

      <%= form.govuk_select(:application_type_id, ApplicationType.menu, label: { text: "Application type" }) %>
    <% end %>
  </div>
  <div class="govuk-form-group govuk-!-margin-top-8">
    <%= form.govuk_date_field :received_at %>
  </div>
  <div class="govuk-form-group govuk-!-margin-top-8">
    <h2 class="govuk-heading-m">
      Site Details
    </h2>
    <%= form.label :address_1, class: "govuk-label" %>
    <%= form.text_field :address_1, class: "govuk-textarea" %>
    <%= form.label :address_2, class: "govuk-label" %>
    <%= form.text_field :address_2, class: "govuk-textarea" %>
    <%= form.label :town, class: "govuk-label" %>
    <%= form.text_field :town, class: "govuk-textarea govuk-input" %>
    <%= form.label :county, class: "govuk-label" %>
    <%= form.text_field :county, class: "govuk-textarea govuk-input" %>
    <%= form.label :postcode, class: "govuk-label" %>
    <%= form.text_field :postcode, class: "govuk-textarea govuk-input--width-10" %>
    <%= form.label :uprn, "UPRN", class: "govuk-label" %>
    <%= form.text_field :uprn, class: "govuk-textarea govuk-input--width-10" %>
  </div>
  <fieldset class="govuk-fieldset">
    <legend class="govuk-fieldset__legend govuk-fieldset__legend--m">
      <h2 class="govuk-fieldset__heading">
        Has the work been started?
    </h2>
    </legend>
      <div class="govuk-form-group">
        <div class="govuk-radios--inline">
          <%= form.govuk_radio_button :work_status, "existing", label: { text: 'Yes' } %>
          <%= form.govuk_radio_button :work_status, "proposed", label: { text: 'No' } %>
        </div>
      </div>
  </fieldset>

  <% ["applicant", "agent"].each do |role| %>
    <fieldset class="govuk-fieldset">
      <legend class="govuk-fieldset__legend govuk-fieldset__legend--m">
        <h2 class="govuk-fieldset__heading">
          <%= role.humanize %> information
        </h2>
      </legend>

      <div class="govuk-form-group">
        <%= form.label "#{role}_first_name", "First name", class: "govuk-label" %>
        <%= form.text_field "#{role}_first_name", class: "govuk-textarea govuk-input" %>
        <%= form.label "#{role}_last_name", "Last name", class: "govuk-label" %>
        <%= form.text_field "#{role}_last_name", class: "govuk-textarea govuk-input" %>
        <%= form.label "#{role}_email", "Email address", class: "govuk-label" %>
        <%= form.text_field "#{role}_email", class: "govuk-textarea govuk-input" %>
        <%= form.label "#{role}_phone", "UK telephone number", class: "govuk-label" %>
        <%= form.text_field "#{role}_phone", class: "govuk-textarea govuk-input" %>
      </div>
    </fieldset>
  <% end %>


  <div class="govuk-form-group govuk-!-margin-top-8">
    <h2 class="govuk-heading-m">
      Fee information
    </h2>
    <%= form.label :payment_reference, class: "govuk-label" %>
    <%= form.text_field :payment_reference, class: "govuk-textarea govuk-input" %>

    <%= form.label :payment_amount, class: "govuk-label" %>
    <div class="govuk-input__wrapper">
      <div class="govuk-input__prefix" aria-hidden="true">Â£</div>
      <%= form.text_field :payment_amount, value: number_to_currency(@planning_application.payment_amount, unit: ""), class: "govuk-textarea govuk-input" %>
    </div>
  </div>

  <div class="govuk-button-group">
    <%= form.submit "Save", class: "govuk-button", data: { module: "govuk-button" } %>
    <%= link_to 'Cancel', planning_applications_path, class: "govuk-button govuk-button--secondary" %>
  </div>
<% end %>
