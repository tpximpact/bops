<% content_for :page_title do %>
  Check neighbour notifications - <%= t("page_title") %>
<% end %>
<% render(
  partial: "shared/review_task_breadcrumbs",
  locals: {
    planning_application: @planning_application,
    current_page: "Check neighbour notifications"
  }
) %>
<%= render(
  partial: "shared/proposal_header",
  locals: { heading: "Check neighbour notifications" }
) %>
<div class="govuk-grid-row">
  <div class="govuk-grid-column-full">
    <hr class="govuk-section-break govuk-section-break--l govuk-section-break--visible">

    <%= render(
      partial: "shared/location_map",
      locals: {
        locals: {
          in_accordion: false,
          geojson: @planning_application.neighbour_geojson,
          geojson_field: "consultation-polygon-geojson-field"
        }
      }
    ) %>

    <% if @consultation.neighbours.any? %>
      <table class="govuk-table govuk-!-margin-top-6">
        <thead class="govuk-table__head">
          <tr class="govuk-table__row">
            <th scope="col" class="govuk-table__header govuk-!-width-one-half">Address list</th>
            <th scope="col" class="govuk-table__header govuk-!-width-one-quarter">Source</th>
            <th scope="col" class="govuk-table__header">Status</th>
            <th scope="col" class="govuk-table__header govuk-table__header--numeric">Last contacted</th>
          </tr>
        </thead>
        <tbody class="govuk-table__body">
          <% @consultation.neighbours.each do |neighbour| %>
            <% next if neighbour.sent_comment? %>
              <tr class="govuk-table__row">
                <td class="govuk-table__cell govuk-!-width-one-third">
                  <%= neighbour.address %>
                </td>
                <td class="govuk-table__cell">
                  <%= neighbour.source&.humanize %>
                </td>
                <td class="govuk-table__cell">
                  <% if neighbour.last_letter.blank? %>
                    <%= render(StatusTags::LetterComponent.new(status: "new")) %>
                  <% else %>
                    <%= render(StatusTags::LetterComponent.new(status: NeighbourLetter::STATUSES[neighbour.last_letter.status&.to_sym])) %>
                  <% end %>
                </td>
                <td class="govuk-table__cell govuk-table__cell--numeric govuk-!-width-one-quarter">
                  <% if neighbour.last_letter.blank? %>
                    -
                  <% elsif neighbour.last_letter.status_updated_at.present? %>
                    <%= neighbour.last_letter.status_updated_at.to_date.to_fs(:day_month_year_slashes) %>
                  <% else %>
                    <%= neighbour.last_letter.created_at.to_fs(:day_month_year_slashes) %>
                  <% end %>
                </td>
              </tr>
          <% end %>
        </tbody>
      </table>
    <% else %>
      No neighbours were consulted
    <% end %>

    <hr class="govuk-section-break govuk-section-break--l govuk-section-break--visible">
  </div>

  <div class="govuk-grid-column-two-thirds">

    <%= form_with model: [@consultation, @neighbour_review], url: planning_application_review_consultation_neighbour_responses_path(@planning_application) do |form| %>
      <%= form.govuk_radio_buttons_fieldset(:action, legend: { size: 'm', text: 'Do you accept that notifications have been completed within the correct period?' }) do %>
        <% if @consultation.start_date && @consultation.end_date %>
          <ul class="govuk-list govuk-list--bullet">
            <li>the consultation period for this application is <%= (@consultation.end_date - @consultation.start_date).to_i %> days</li>
            <li>the last letter was sent <%= (Date.current - @consultation.neighbour_letters.max_by(&:sent_at).sent_at.to_date).to_i %> days ago</li>
            <li>the consultation expiry date for this application is <%= @consultation.end_date.to_date.to_fs %></li>
          </ul>
        <% else %>
          <p class="govuk-body">The consultation has not been started</p>
        <% end %>
        <%= form.govuk_radio_button :action, 'accepted', label: { text: 'Accept' }, link_errors: true %>
        <%= form.govuk_radio_button :action, 'rejected', label: { text: 'Return to officer with comment' } do %>
          <%= form.govuk_text_area :comment, label: { text: 'Explain why notifications are incomplete.' } %>
        <% end %>
      <% end %>

      <div class="govuk-button-group">
        <%= form.submit "Save and mark as complete", class: "govuk-button", data: { module: "govuk-button" } %>
        <%= back_link %>
      </div>
    <% end %>
  </div>
</div>
