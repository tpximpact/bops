<%= bops_task_accordion(id: "review-conditions-section") do |accordion| %>
  <% accordion.with_heading(text: "Review conditions") %>
  <% if @planning_application.review_heads_of_terms? %>
    <% accordion.with_section(id: "review-heads-of-terms", expanded: @planning_application.heads_of_term.errors.any?) do |section| %>
      <%= section.with_heading(text: "Review heads of terms") %>
      <%= section.with_status do %>
        <%= render(StatusTags::ReviewComponent.new(review_item: @planning_application.heads_of_term.current_review)) %>
      <% end %>
        <% section.with_block do %>
        <div class="govuk-grid-row">
          <div class="govuk-grid-column-two-thirds">
            <%= render "planning_applications/review/heads_of_terms/terms_summary" %>

            <h3 class="govuk-heading-s">
              Submitted recommendation
            </h3>
            <p class="govuk-body">
              by <%= @planning_application.user&.name %>, <%= @planning_application.in_assessment_at.to_fs %>
            </p>

            <%= render(ReviewerCommentComponent.new(comment: @planning_application.heads_of_term.current_review)) %>
          </div>
        </div>
      <% end %>
      <%= section.with_footer do %>
        <%= render(partial: "planning_applications/review/heads_of_terms/form",
              locals: {heads_of_term: @planning_application.heads_of_term}) %>
      <% end %>
    <% end %>
  <% end %>

  <% if @planning_application.possibly_immune? && @planning_application.immunity_detail.reviews.evidence.any? %>
    <%= accordion.with_section(id: "review-evidence", expanded: @planning_application.immunity_detail.current_evidence_review_immunity_detail.errors.any?) do |section| %>
      <% section.with_heading(text: "Review evidence of immunity") %>

      <% section.with_status do %>
        <%= render(
              StatusTags::ReviewComponent.new(
                review_item: @planning_application.immunity_detail.current_evidence_review_immunity_detail
              )
            ) %>
      <% end %>

      <% section.with_block do %>
        <%= render(PlanningApplications::ImmunityDetailsComponent.new(immunity_details: @planning_application.immune_proposal_details)) %>
      <% end %>

      <% section.with_footer(id: "review-evidence-form") do %>
        <%= render(partial: "planning_applications/review/immunity_details/form") %>
      <% end %>
    <% end %>
  <% end %>

  <% if @planning_application.possibly_immune? && @planning_application.immunity_detail.reviews.enforcement.any? %>
    <%= accordion.with_section(id: "review-enforcement", expanded: @planning_application.immunity_detail.current_enforcement_review_immunity_detail.errors.any?) do |section| %>
      <% section.with_heading(text: "Review assessment of immunity") %>

      <% section.with_status do %>
        <%= render(
              StatusTags::ReviewComponent.new(
                review_item: @planning_application.immunity_detail.current_enforcement_review_immunity_detail
              )
            ) %>
      <% end %>

      <% section.with_block do %>
        <%= render(partial: "planning_applications/review/immunity_enforcements/details") %>
      <% end %>

      <% section.with_footer(id: "review-enforcement-form") do %>
        <%= render(partial: "planning_applications/review/immunity_enforcements/form") %>
      <% end %>
    <% end %>
  <% end %>

  <% if @planning_application.application_type.planning_conditions? %>
    <% if @planning_application.condition_set&.current_review&.started? %>
      <%= accordion.with_section(id: "review-conditions", expanded: @planning_application.condition_set.errors.any?) do |section| %>
        <% section.with_heading(text: "Review conditions") %>

        <% section.with_status do %>
          <%= render(
                StatusTags::ReviewComponent.new(
                  review_item: @planning_application.condition_set.current_review,
                  updated: @planning_application.condition_set.current_review&.status == "updated"
                )
              ) %>
        <% end %>

        <% section.with_block do %>
          <%= render(partial: "planning_applications/review/conditions/conditions_table") %>
        <% end %>

        <% section.with_footer(id: "review-conditions-form") do %>
          <%= render(partial: "planning_applications/review/conditions/form") %>
        <% end %>
      <% end %>
    <% end %>
    <% if @planning_application.pre_commencement_condition_set&.current_review&.started? %>
      <%= accordion.with_section(id: "review-pre-commencement-conditions", expanded: @planning_application.pre_commencement_condition_set.errors.any?) do |section| %>
        <% section.with_heading(text: "Review pre-commencement conditions") %>

        <% section.with_status do %>
          <%= render(
                StatusTags::ReviewComponent.new(
                  review_item: @planning_application.pre_commencement_condition_set.current_review,
                  updated: @planning_application.pre_commencement_condition_set.current_review&.status == "updated"
                )
              ) %>
        <% end %>

        <% section.with_block do %>
          <%= render(partial: "planning_applications/review/pre_commencement_conditions/table") %>
        <% end %>

        <% section.with_footer(id: "review-pre-commencement-form") do %>
          <%= render(partial: "planning_applications/review/pre_commencement_conditions/form") %>
        <% end %>
      <% end %>
      <%= render(
            TaskListItems::Reviewing::ConditionsComponent.new(
              condition_set: @planning_application.pre_commencement_condition_set
            )
          ) %>
    <% end %>
  <% end %>

  <% if @planning_application.application_type.informatives? %>
    <% if @planning_application.informative_set&.current_review&.started? %>
      <%= render "planning_applications/review/tasks/review_informatives",
            accordion: accordion,
            current_review: @planning_application.informative_set.current_review,
            informatives: @planning_application.informative_set.informatives %>
    <% end %>
  <% end %>

  <% if @planning_application.consideration_set.current_review %>
    <%= render "planning_applications/review/tasks/review_considerations",
          accordion: accordion,
          current_review: @planning_application.consideration_set.current_review,
          considerations: @planning_application.consideration_set.considerations %>
  <% end %>
<% end %>

<ul class="app-task-list__items" id="review-conditions-section">
  <% if @planning_application.review_permitted_development_rights? %>
    <%= render(
          TaskListItems::Reviewing::PermittedDevelopmentRightComponent.new(
            planning_application: @planning_application
          )
        ) %>
  <% end %>

  <%= render partial: "planning_applications/review/tasks/policy_classes", locals: {planning_application: @planning_application, policy_class: @policy_class} %>

  <% if @planning_application.application_type.assess_against_policies? %>
    <%= render partial: "planning_applications/review/tasks/policy_classes_new", locals: {planning_application: @planning_application, policy_class: @policy_class} %>
  <% end %>

  <%= render "planning_applications/review/tasks/sign_off_recommendation" %>

  <% if @planning_application.committee_decision.present? && @planning_application.committee_decision.recommend? %>
    <%= render(
          TaskListItems::Reviewing::NotifyCommitteeComponent.new(
            planning_application: @planning_application
          )
        ) %>
  <% end %>

  <% if @planning_application.committee_decision.present? && @planning_application.committee_decision.recommend? %>
    <li class="app-task-list__item">
      <span class="app-task-list__task-name">
        <%= link_to_if(
              @planning_application.in_committee?,
              "Update decision notice after committee",
              edit_planning_application_review_recommendation_path(@planning_application, @planning_application.recommendation),
              aria: {describedby: "review_assessment-completed"},
              class: "govuk-link"
            ) %>
      </span>
      <div class="govuk-task-list__status app-task-list__task-tag">
      <%= render(
            StatusTags::AddCommitteeDecisionComponent.new(
              planning_application: @planning_application
            )
          ) %>
      </div>
    </li>
  <% end %>
</ul>
