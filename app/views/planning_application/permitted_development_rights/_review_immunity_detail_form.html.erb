<%= form_with(
  model: @form, 
  local: true,
  builder: GOVUKDesignSystemFormBuilder::FormBuilder,
  url: planning_application_permitted_development_rights_path(@planning_application)
  ) do |form| %>
    <%= form.govuk_error_summary(presenter: ErrorPresenter) %>

    <div class="govuk-form-group <%= form.object.errors.any? ? 'govuk-form-group--error' : '' %>">
      <%= form.fields_for :review_immunity_detail do |review_immunity_detail| %>
        <%= review_immunity_detail.govuk_radio_buttons_fieldset(
          :decision,
          legend: { text: "Is the application immune from enforcement?", size: "s" },
        ) do %>

          <div data-controller="show-hide">
            <div id="review-immunity-detail-section">
              <%= review_immunity_detail.govuk_radio_button(
                :decision, "Yes", 
                label: { text: "Yes" },
                link_errors: true,
                data: {
                  action: "change->show-hide#handleEventForDecision",
                  show_hide_target: "toggleable"
                }
              ) do %>

                <%= form.govuk_radio_buttons_fieldset(:decision_type, legend: nil) do %>
                  <%= review_immunity_detail.govuk_radio_button(
                    :decision_type, I18n.t("review_immunity_detail_permitted_development_right_form.four_years_substantial"), label: { text: I18n.t("review_immunity_detail_permitted_development_right_form.four_years_substantial") }, link_errors: true
                  ) %>
                  <%= review_immunity_detail.govuk_radio_button(
                    :decision_type, I18n.t("review_immunity_detail_permitted_development_right_form.four_years_unauthorised"), label: { text: I18n.t("review_immunity_detail_permitted_development_right_form.four_years_unauthorised") }
                  ) %>
                  <%= review_immunity_detail.govuk_radio_button(
                    :decision_type, I18n.t("review_immunity_detail_permitted_development_right_form.ten_years_other_breach"), label: { text: I18n.t("review_immunity_detail_permitted_development_right_form.ten_years_other_breach") }
                  ) %>
                  <%= review_immunity_detail.govuk_radio_button(
                    :decision_type, I18n.t("review_immunity_detail_permitted_development_right_form.other"), label: { text: I18n.t("review_immunity_detail_permitted_development_right_form.other") }, link_errors: true
                  ) do %>
                    <%= review_immunity_detail.govuk_text_area :yes_decision_reason, label: { text: "Please provide a reason" }, link_errors: true %>
                  <% end %>
                <% end %>
              <% end %>

              <%= review_immunity_detail.govuk_radio_button(
                :decision, "No", 
                label: { text: "No" },
                data: {
                  action: "change->show-hide#handleEventForDecision",
                  show_hide_target: "toggleableWhenNo"
                },
                link_errors: true
              ) do %>
                <%= review_immunity_detail.govuk_text_area(
                  :no_decision_reason, rows: 6, label: { text: "Describe why the application is not immune from enforcement", link_errors: true }
                ) %>
              <% end %>

              <div data-show-hide-target="toggleableWhenYes" class="display-none">
                <%= review_immunity_detail.govuk_text_area(
                  :summary, 
                  rows: 6, 
                  label: { text: "Immunity from enforcement summary", class: "govuk-label govuk-label--s" },
                  hint: { text: "Refer to the evidences and history provided" }
                ) %>
              </div>
            </div>

            <div data-show-hide-target="toggleableWhenNo" class="display-none" id="permitted-development-right-section">  
              <h3 class="govuk-heading-m govuk-!-padding-top-4">
                Permitted development rights
              </h3>

              <%= form.fields_for :permitted_development_right do |permitted_development_right| %>
                <%= permitted_development_right.govuk_radio_buttons_fieldset(
                  :removed,
                  legend: { text: "Have the permitted development rights relevant for this application been removed?", size: "s" }
                ) do %>

                  <%= permitted_development_right.govuk_radio_button(
                    :removed, true, label: { text: "Yes" }
                  ) do %>
                    <%= permitted_development_right.govuk_text_area(
                      :removed_reason, rows: 6, label: { text: "Describe how permitted development rights have been removed" }
                    ) %>
                  <% end %>

                  <%= permitted_development_right.govuk_radio_button(
                    :removed, false, label: { text: "No" }
                  ) %>
                <% end %>
              <% end %>
            </div>
          <% end %>

        <%= render(partial: "shared/submit_buttons", locals: { form: form }) %>
      </div>
    </div>
  <% end %>
<% end %>
