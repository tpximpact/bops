<h3 class="govuk-heading-s">Summary of selected neighbours</h3>
<% if @consultation.neighbours.select(&:persisted?).any? %>
    <div class="proposal-details-sub-heading" data-controller="edit-form">
      <table>
        <% @consultation.neighbours.includes([:neighbour_letter]).select(&:persisted?).each do |neighbour| %>
          <tr>
            <td class="govuk-body">
              <%= neighbour.address %>
            </td>
            <td class="govuk-body">
              <% if neighbour.neighbour_letter %>
                <%= NeighbourLetter::STATUSES["#{neighbour.neighbour_letter.status}"] %>
                <%= neighbour.neighbour_letter.status_updated_at %>
              <% else %>
                &nbsp;
              <% end %>
            </td>
            <td>
              <%= form_with(
                model: [@planning_application, @consultation],
                builder: GOVUKDesignSystemFormBuilder::FormBuilder,
                data: { action: "submit->submit-form#handleSubmit" },
                class: "display-none"
              ) do |form| %>
                <%= form.govuk_error_summary(presenter: ErrorPresenter) %>
                <%= form.fields_for :neighbours, neighbour do |ff| %>
                  <%= ff.govuk_text_field :address %>
                  <%= ff.hidden_field :consultation_id, value: @consultation.id %>
                <% end %>
                <br>
                <%= form.submit(
                  "Save",
                  class: "govuk-button govuk-button--secondary"
                ) %>
              <% end %>

              <div class="neighbour-action-links">
                <%= link_to(
                    "Edit",
                    "#",
                    class: "govuk-link",
                    data: { action: "click->edit-form#handleClick" }
                  ) 
                %>

                <%= link_to(
                      "Remove",
                      planning_application_consultation_path(
                          @planning_application,
                          @consultation,
                          neighbour: neighbour
                      ),
                      method: :delete,
                      class: "govuk-link"
                ) %>
              </div>
            </td>
          </tr>
        <% end %>
      </table>
    </div>
<% else %>
  <p class="govuk-body">No neighbours selected yet</p>
<% end %>
