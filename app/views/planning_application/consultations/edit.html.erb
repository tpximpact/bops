<% content_for :page_title do %>
  Send letters to neighbours - <%= t('page_title') %>
<% end %>

<% add_parent_breadcrumb_link "Home", root_path(filter_options: PlanningApplication::FILTER_OPTIONS) %>
<% add_parent_breadcrumb_link "Application", planning_application_path(@planning_application) %>
<% add_parent_breadcrumb_link "Consultation", planning_application_path(@planning_application) %>
<% content_for :title, "Send letters to neighbours" %>

<%= render(
  partial: "shared/proposal_header",
  locals: { heading: "Send letters to neighbours" }
) %>

<div class="govuk-grid-row">
  <div class="govuk-grid-column-full" data-controller="address-fill">
    <%= render "form", planning_application: @planning_application, consultation: @consultation %>

    <%= render(
      partial: "shared/location_map",
      locals: {
        locals: {
          in_accordion: false,
          geojson: @planning_application.boundary_geojson
        }
      }
    ) %>

    <br>
    <h3 class="govuk-heading-m">Summary of selected neighbours</h3>
    <% if @consultation.neighbours.any? %>
      <% @consultation.neighbours.select(&:persisted?).each do |neighbour| %>
        <hr>
        <div data-controller="edit-form">
          <p class="govuk-body"><%= neighbour.address %></p>

          <%= form_with(
            model: [@planning_application, @consultation],
            builder: GOVUKDesignSystemFormBuilder::FormBuilder,
            data: { action: "submit->submit-form#handleSubmit" },
            class: "display-none"
          ) do |form| %>
            <%= form.govuk_error_summary(presenter: ErrorPresenter) %>
            <%= form.fields_for :neighbours, neighbour do |ff| %>
              <%= ff.govuk_text_field :address %>
              <%= ff.hidden_field :consultation_id, value: @consultation.id %>
            <% end %>
            <br>
            <%= form.submit(
              "Edit neighbour",
              class: "govuk-button govuk-button--secondary"
            ) %>
          <% end %>

          <div class="neighbour-action-links">
            <%= link_to(
                  "Remove from list",
                  planning_application_consultation_path(
                      @planning_application,
                      @consultation,
                      neighbour: neighbour
                  ),
                  method: :delete,
                  class: "govuk-link"
            ) %>

            <%= link_to(
                "Edit neighbour",
                "#",
                class: "govuk-link",
                data: { action: "click->edit-form#handleClick" }
              ) 
            %>
          </div>
        </div>
      <% end %>
    <% else %>
      <p class="govuk-body">No neighbours selected yet</p>
    <% end %>
    <br>
    <%= link_to "Back", planning_application_path(@planning_application), class: "govuk-button govuk-button--secondary" %>
  </div>
</div>
