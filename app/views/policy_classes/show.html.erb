<% content_for :page_title do %>
  Assess - <%= t('page_title') %>
<% end %>

<% add_parent_breadcrumb_link "Home", planning_applications_path %>
<% add_parent_breadcrumb_link "Application", planning_application_path(@planning_application) %>

<% content_for :title, "Assess" %>

<div class="govuk-grid-row">
  <div class="govuk-grid-column-two-thirds">
    <h1 class="govuk-heading-l">Assess - <%= @policy_class %></h1>
    <h2 class="govuk-heading-m">
      <%= t(".class_title", policy_class: @policy_class.name) %>
    </h2>

    <p class="govuk-body">
      Please indicate if the application complies, does not comply, or
      is not applicable to each of the policies. Policies are defined in the Town and Country
      Planning (General Permitted Development) (England) Order 2015,
      Schedule 2, <%= @policy_class %>.</p>

    <p class="govuk-body">
      <%= link_to "Open legislation in new window", @policy_class.url, class: "govuk-link", target: "_blank" %>
    </p>

    <%= button_to(
        "Remove class from assessment",
        nil,
        method: :delete,
        class: "govuk-button govuk-button--warning",
        disabled: @planning_application.assessment_complete?
    ) %>
  </div>
</div>

<div class="govuk-grid-row">
  <div class="govuk-grid-column-full">
    <%= form_with(
      model: [@planning_application, @policy_class],
      html: { data: unsaved_changes_data },
      builder: GOVUKDesignSystemFormBuilder::FormBuilder
    ) do |form| %>
      <%= form.govuk_error_summary %>
      <table class="govuk-table">
        <caption class="govuk-table__caption govuk-table__caption--l"><%= @policy_class %> - <%= @policy_class.name %></caption>
        <thead class="govuk-table__head">
          <tr class="govuk-table__row">
            <th scope="col" class="govuk-table__header govuk-!-width-one-half">Policy reference</th>
            <th scope="col" class="govuk-table__header govuk-!-width-one-quarter-width">Complies</th>
            <th scope="col" class="govuk-table__header govuk-!-width-one-quarter-width">Does not comply</th>
            <th scope="col" class="govuk-table__header govuk-!-width-one-quarter-width">To be determined</th>
          </tr>
        </thead>
        <tbody class="govuk-table__body">
          <%= form.fields_for(:policies) do |policy_form| %>
            <tr class="govuk-table__row">
              <td class="govuk-table__cell">
                <h3 class="govuk-heading-s">
                  <%= "#{form.object.section}.#{policy_form.object.section}" %>
                </h3>
                <p class="govuk-body">
                  <%= policy_form.object.description %>
                </p>
                <%= policy_form.fields_for(
                  :comment,
                  policy_form.object.existing_or_new_comment
                ) do |comment_form| %>
                  <%= comment_form.govuk_text_area(
                    :text,
                    label: {
                      text: policy_comment_label(comment_form.object),
                      size: "s"
                    },
                    rows: 2
                  ) %>
                <% end %>
              </td>
              <% Policy.statuses.each_key do |status| %>
                <td class="govuk-table__cell">
                  <div class="govuk-form-group">
                    <fieldset class="govuk-fieldset">
                      <div class="govuk-radios" data-module="govuk-radios">
                        <div class="govuk-radios govuk-radios--small">
                          <div class="govuk-radios__item">
                            <%= policy_form.radio_button(
                              :status,
                              status,
                              class: "govuk-radios__input",
                              disabled: @planning_application.assessment_complete?
                            ) %>
                            <%= policy_form.label(
                              :status,
                              "&nbsp;".html_safe,
                              class: "govuk-label govuk-radios__label"
                            ) %>
                          </div>
                        </div>
                      </div>
                    </fieldset>
                  </div>
                </td>
              <% end %>
            </tr>
          <% end %>
        </tbody>
      </table>

      <div class="govuk-button-group">
        <%= form.submit(
          t(".save_and_mark"),
          class: "govuk-button",
          disabled: @planning_application.assessment_complete?
        ) %>
        <%= form.submit(
          t(".save_and_come"),
          class: "govuk-button govuk-button--secondary",
          disabled: @planning_application.assessment_complete?
        ) %>
        <%= link_to "Back", :back, class: "govuk-button govuk-button--secondary" %>
      </div>
    <% end %>
  </div>
</div>
